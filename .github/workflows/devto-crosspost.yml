name: Dev.to Cross-Posting

on:
  schedule:
    # Run daily at 1:00 PM UTC (10:00 PM KST)
    # After content generation (10 AM UTC) and deployment
    - cron: '0 13 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview without publishing'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      file:
        description: 'Specific file to publish (optional)'
        required: false
        default: ''
      delay_days:
        description: 'Delay in days before cross-posting (default: 3)'
        required: false
        default: '3'

jobs:
  crosspost:
    name: Cross-post EN articles to Dev.to
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Cross-post to Dev.to
        continue-on-error: true
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          INPUT_DRY_RUN: ${{ github.event.inputs.dry_run }}
          INPUT_FILE: ${{ github.event.inputs.file }}
          INPUT_DELAY_DAYS: ${{ github.event.inputs.delay_days }}
        run: |
          ARGS=""

          if [ "$INPUT_DRY_RUN" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          if [ -n "$INPUT_FILE" ]; then
            ARGS="$ARGS --file $INPUT_FILE"
          fi

          if [ -n "$INPUT_DELAY_DAYS" ]; then
            ARGS="$ARGS --delay-days $INPUT_DELAY_DAYS"
          fi

          python scripts/devto_publisher.py $ARGS

      - name: Commit tracking data
        run: |
          git config user.name "Content Bot"
          git config user.email "bot@jakes-tech-insights.com"

          if [ -f data/devto_published.json ]; then
            git add data/devto_published.json
            if ! git diff --staged --quiet; then
              git commit -m "ðŸ“¤ Dev.to cross-post: Updated tracking data"

              # Push with retry
              MAX_RETRIES=3
              for i in $(seq 1 $MAX_RETRIES); do
                if git push origin main; then
                  echo "âœ… Tracking data committed"
                  break
                fi
                echo "Push failed, retrying ($i/$MAX_RETRIES)..."
                sleep 2
                git pull --no-rebase origin main || true
              done
            else
              echo "No tracking changes to commit"
            fi
          fi
