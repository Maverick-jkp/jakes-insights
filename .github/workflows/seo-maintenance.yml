name: SEO Maintenance

on:
  # Scheduled runs temporarily disabled - enable after testing
  # schedule:
  #   # Run weekly on Sundays at 3:00 AM KST (6:00 PM UTC Saturday)
  #   - cron: '0 18 * * 6'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - 'all'
          - 'google-indexing'
          - 'evergreen-update'
        default: 'all'
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        type: boolean
        default: false

jobs:
  evergreen-update:
    name: Update Evergreen Content
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'evergreen-update' || github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-frontmatter

      - name: Update evergreen posts
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          echo "ðŸŒ² Updating evergreen content..."
          python scripts/evergreen_updater.py --min-age 30 --top-percent 0.2 --max-updates 10 $DRY_RUN_FLAG

      - name: Commit evergreen updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "SEO Bot"
          git config user.email "seo-bot@jakes-tech-insights.com"

          if ! git diff --quiet content/ data/evergreen_updates.json; then
            git add content/ data/evergreen_updates.json

            # Multi-line commit message
            git commit -m "ðŸŒ² Evergreen update: Refreshed top 20% posts" \
                       -m "- Updated lastmod dates for freshness" \
                       -m "- Maintains SEO ranking" \
                       -m "- Improves search visibility" \
                       -m "" \
                       -m "Automated by SEO Maintenance workflow"

            git push origin main
            echo "âœ… Pushed evergreen updates"
          else
            echo "â„¹ï¸  No updates needed"
          fi

  google-indexing:
    name: Notify Google Indexing API
    runs-on: ubuntu-latest
    needs: evergreen-update
    if: |
      always() &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'google-indexing' || github.event_name == 'schedule') &&
      github.event.inputs.dry_run != 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-auth google-api-python-client python-frontmatter

      - name: Setup Google credentials
        env:
          GOOGLE_INDEXING_CREDENTIALS: ${{ secrets.GOOGLE_INDEXING_CREDENTIALS }}
        run: |
          mkdir -p credentials
          echo "$GOOGLE_INDEXING_CREDENTIALS" > credentials/google-indexing-credentials.json

      - name: Notify Google Indexing API
        run: |
          echo "ðŸ“¤ Notifying Google about recent updates..."

          # Index posts from last 7 days (includes evergreen updates)
          python scripts/google_indexing.py --days 7

          echo "âœ… Google Indexing API notifications sent"

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f credentials/google-indexing-credentials.json

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [evergreen-update, google-indexing]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸŽ¯ SEO Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.evergreen-update.result }}" = "success" ]; then
            echo "âœ… Evergreen content updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Evergreen update: ${{ needs.evergreen-update.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.google-indexing.result }}" = "success" ]; then
            echo "âœ… Google Indexing API notified" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.google-indexing.result }}" = "skipped" ]; then
            echo "â­ï¸ Google Indexing API: skipped (dry run)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Google Indexing API: ${{ needs.google-indexing.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next run:** Weekly on Sundays at 3:00 AM KST" >> $GITHUB_STEP_SUMMARY
