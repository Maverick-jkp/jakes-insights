# System 4.5: Pragmatic Parallel Workflows

**Version**: 4.5
**Date**: 2026-01-22
**Philosophy**: Sequential simplicity + Parallel performance (when obvious)

---

## ğŸ¯ TL;DR (Read This First)

System 4.5 = System 4.0 + Smart parallelization

**What changed**:
- âœ… Parallel execution allowed (when scopes don't overlap)
- âœ… Pre-commit hook enforces boundaries (automatic safety)
- âœ… Same reporting workflow (no new complexity)
- âœ… Master still orchestrates (simple mental model)

**What stayed the same**:
- Master orchestrates all work
- Agents create reports before returning
- Only Master commits to main
- Sequential workflow by default

**Result**: 30-40% faster, same safety, same simplicity

---

## Core Workflow

### Sequential (Default)

```
User Request
    â†“
Master analyzes
    â†“
Agent A works â†’ Report â†’ Master reviews â†’ Commit
    â†“
Agent B works â†’ Report â†’ Master reviews â†’ Commit
```

**Use when**: Unsure, dependency exists, scopes overlap

### Parallel (NEW - When obvious)

```
User Request
    â†“
Master analyzes (scopes disjoint?)
    â†“
Agent A works â†’ Report â”€â”
Agent B works â†’ Report â”€â”¼â†’ Master reviews both â†’ Commit
Agent C works â†’ Report â”€â”˜
```

**Use when**: Scopes 100% disjoint, no dependencies, obvious

---

## Scope Ownership Map

### Designer

**Owns** (can commit directly to):
```
layouts/
â”œâ”€â”€ _default/
â”œâ”€â”€ partials/
â””â”€â”€ index.html

assets/
â””â”€â”€ css/

static/
â””â”€â”€ images/ (non-content images)
```

**NEVER touch**:
- `scripts/`
- `.github/`
- `content/` (generated by CTO scripts)

### CTO

**Owns** (can commit directly to):
```
scripts/
.github/workflows/
hugo.toml (except theme settings)
data/
.hugo_modules/
```

**NEVER touch**:
- `layouts/` (unless technical bug fix, needs Master approval)
- `assets/css/`
- `static/images/`

### QA

**Owns** (can commit directly to):
```
tests/
pytest.ini
.coveragerc
scripts/utils/validation.py (quality checks only)
```

**Inspection only** (no writes):
- All other files (QA validates but doesn't modify)

**Always creates reports** (never commits to source code)

### Master

**Owns**:
```
.claude/
â”œâ”€â”€ session-state.json
â”œâ”€â”€ reports/active/master-*.md
â”œâ”€â”€ mistakes-log.md
â””â”€â”€ CLAUDE.md / CLAUDE-4.5.md

quality_report.json
generated_files.json
```

**Orchestrates**: All multi-agent workflows
**Validates**: All commits before pushing to main

---

## Decision Tree: Parallel or Sequential?

```
Task received
    â†“
How many agents needed?
    â”œâ”€ One agent â†’ Delegate (sequential)
    â””â”€ Multiple agents â†’ Check overlap
           â†“
        Do scopes overlap?
        â”œâ”€ YES â†’ Sequential
        â”‚   â””â”€ Examples: Both touch hugo.toml, Designer needs CTO's output
        â”‚
        â””â”€ NO â†’ Check dependency
               â”œâ”€ Has dependency? â†’ Sequential
               â”‚   â””â”€ Example: CTO generates data, Designer displays it
               â”‚
               â””â”€ Independent? â†’ PARALLEL âœ¨
                   â””â”€ Example: Designer fixes layouts/, CTO fixes scripts/
```

**Golden Rule**: **When in doubt, use sequential.** (No penalty)

---

## Examples

### Example 1: Parallel Execution (Obvious)

**Task**: "Fix SEO issues identified by QA"

**Analysis**:
- Designer: Add hreflang meta tags to `layouts/partials/head.html`
- CTO: Fix sitemap generation in `hugo.toml`
- Scopes: `layouts/` vs `hugo.toml` â†’ **No overlap**
- Dependency: None
- **Decision: PARALLEL**

**Execution**:
```bash
# Master spawns both agents simultaneously
Task designer "Add hreflang meta tags to <head>"
Task cto "Fix sitemap.xml generation config"

# Both work in parallel (2 hours max, not 4 hours sequential)
# Both create reports in .claude/reports/active/
# Master reviews both reports
# Pre-commit hook validates scopes automatically
# Master commits both changes together
```

**Time**: 2h (parallel max) vs 4h (sequential sum)
**Savings**: 50%

---

### Example 2: Sequential Execution (Dependency)

**Task**: "Add trending posts section to homepage"

**Analysis**:
- CTO: Create script to calculate trending posts (`scripts/trending.py`)
- Designer: Display trending posts on homepage (`layouts/index.html`)
- Scopes: `scripts/` vs `layouts/` â†’ **No overlap**
- Dependency: **Designer needs CTO's data structure first**
- **Decision: SEQUENTIAL**

**Execution**:
```bash
# Master delegates sequentially
Task cto "Create trending posts calculation script"
# CTO works â†’ reports with data structure spec

# Master reviews, then delegates next
Task designer "Display trending posts using CTO's data format"
# Designer works â†’ reports

# Master commits both
```

**Time**: 2h + 1.5h = 3.5h
**Why not parallel**: Designer would need to guess data format

---

### Example 3: Sequential Execution (Scope Overlap)

**Task**: "Update site configuration"

**Analysis**:
- CTO: Change build settings in `hugo.toml`
- Designer: Change theme settings in `hugo.toml`
- Scopes: **SAME FILE** â†’ Overlap
- **Decision: SEQUENTIAL**

**Execution**:
```bash
# Master delegates sequentially
Task cto "Update build configuration in hugo.toml"
# CTO works â†’ commits

# Master then delegates
Task designer "Update theme settings in hugo.toml"
# Designer works based on CTO's changes â†’ commits

# Or: Designer creates report for Master to merge manually
```

**Why not parallel**: Git merge conflict guaranteed

---

### Example 4: Three Agents in Parallel (Rare but possible)

**Task**: "Complete pre-launch quality check"

**Analysis**:
- Designer: Verify all pages render correctly (visual QA)
- CTO: Run performance benchmarks (`scripts/benchmark.py`)
- QA: Execute full test suite (`pytest`)
- Scopes: No overlap
- Dependency: None (all independent checks)
- **Decision: PARALLEL**

**Execution**:
```bash
# Master spawns all three
Task designer "Visual QA of all key pages"
Task cto "Run performance benchmarks and optimize"
Task qa "Execute full test suite and validate"

# All three work simultaneously
# All create reports
# Master reviews all three â†’ commits optimizations
```

**Time**: 2h (max of all three) vs 6h (sequential sum)
**Savings**: 67%

---

## Pre-Commit Hook (Automatic Enforcement)

### Installation

```bash
# Copy hook to .git/hooks/
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# System 4.5 Scope Enforcement

AGENT=$(git config user.name)

# Define allowed paths per agent
case $AGENT in
  *Designer*)
    ALLOWED="layouts/ assets/css/ static/images/"
    ;;
  *CTO*)
    ALLOWED="scripts/ .github/ hugo.toml data/ .hugo_modules/"
    ;;
  *QA*)
    ALLOWED="tests/ pytest.ini .coveragerc scripts/utils/validation.py"
    ;;
  *Master*)
    ALLOWED="." # Master can commit anywhere
    ;;
  *)
    echo "âš ï¸  Unknown agent: $AGENT"
    echo "    Set git config user.name to Designer/CTO/QA/Master"
    exit 1
    ;;
esac

# Check staged files
STAGED=$(git diff --cached --name-only)
for file in $STAGED; do
  MATCH=false
  for path in $ALLOWED; do
    if [[ $file == $path* ]] || [[ $path == "." ]]; then
      MATCH=true
      break
    fi
  done

  if [ "$MATCH" = false ]; then
    echo "âŒ SCOPE VIOLATION"
    echo "   Agent: $AGENT"
    echo "   File: $file"
    echo "   Allowed: $ALLOWED"
    echo ""
    echo "   Fix:"
    echo "   1. Unstage: git reset HEAD $file"
    echo "   2. Create report: .claude/reports/active/$AGENT-*.md"
    echo "   3. Let Master handle cross-scope changes"
    exit 1
  fi
done

echo "âœ… Scope check passed ($AGENT)"
EOF

chmod +x .git/hooks/pre-commit
```

### Testing

```bash
# Test Designer trying to modify scripts/ (should fail)
git config user.name "Designer"
echo "test" >> scripts/test.py
git add scripts/test.py
git commit -m "test"
# Expected: âŒ SCOPE VIOLATION

# Test Designer modifying layouts/ (should pass)
git config user.name "Designer"
echo "test" >> layouts/test.html
git add layouts/test.html
git commit -m "test"
# Expected: âœ… Scope check passed (Designer)
```

---

## Session Start Checklist

### Master Agent

```
[ ] 1. Read CLAUDE-4.5.md (this file)
[ ] 2. Read .claude/mistakes-log.md
[ ] 3. Read .claude/session-state.json
[ ] 4. Understand user request
[ ] 5. Identify which agent(s) needed
[ ] 6. Check if scopes overlap (parallel or sequential?)
[ ] 7. Delegate with explicit context
[ ] 8. Receive reports from agents
[ ] 9. Review and validate
[ ] 10. Commit with proper message
```

### Specialized Agents (Designer/CTO/QA)

```
[ ] 1. Receive task and context from Master
[ ] 2. Read .claude/mistakes-log.md
[ ] 3. Implement assigned task (stay in your scope!)
[ ] 4. CREATE REPORT in .claude/reports/active/
[ ] 5. Return to Master (NEVER commit yourself)
```

---

## Rules That Never Change

### âœ… DO

- **Default to sequential** when unsure
- **Create reports** before returning (all agents)
- **Stay in your scope** (pre-commit hook enforces)
- **Let Master commit** (only Master pushes to main)
- **Test builds** before committing (Master's job)

### âŒ NEVER

- **Skip report creation** (even if parallel)
- **Commit to another agent's scope** (hook will block)
- **Assume parallel is always better** (dependencies matter)
- **Rush to parallel** without checking overlap
- **Forget co-authorship** in commit messages

---

## Antipatterns & Correct Patterns

### âŒ Antipattern 1: Forced Parallelization

**Wrong**:
```
Master: "Let's do everything in parallel for speed!"
Designer + CTO both work on hugo.toml simultaneously
â†’ Merge conflict
â†’ Wasted time resolving
```

**Correct**:
```
Master: "hugo.toml has overlap â†’ Sequential"
CTO first, then Designer
â†’ No conflict
â†’ Faster overall (no resolution time)
```

### âŒ Antipattern 2: Skipping Scope Check

**Wrong**:
```
Master: "These seem independent, go parallel"
(Didn't check that both need same data file)
Both agents modify data/topics_queue.json
â†’ Conflict
```

**Correct**:
```
Master: "Check actual file overlap..."
Both need topics_queue.json â†’ Sequential
â†’ No conflict
```

### âŒ Antipattern 3: Agent Commits Directly

**Wrong**:
```
Designer: "I'm done, let me commit and push"
(Bypasses Master review)
â†’ Potential issues go unnoticed
```

**Correct**:
```
Designer: "Report created, returning to Master"
Master reviews report â†’ validates â†’ commits
â†’ Master catches issues before they reach main
```

### âœ… Correct Pattern: Smart Parallel

**Good**:
```
Master analyzes: "Designer fixes layouts/, CTO fixes scripts/"
Files: layouts/index.html vs scripts/generate.py
Overlap: NONE
Dependency: NONE
â†’ Parallel execution âœ…
â†’ 50% time savings âœ…
â†’ Pre-commit hook prevents scope violations âœ…
```

---

## Context Passing Protocol

When Master delegates (parallel or sequential), provide explicit context:

```markdown
You are [AGENT_NAME].

Task: [SPECIFIC_TASK]

Context:
- Files to modify: [EXPLICIT_LIST]
- Your scope: [ALLOWED_PATHS]
- Current state: [BRIEF_SUMMARY]
- Constraints: [TECHNICAL_OR_DESIGN_LIMITS]

Expected output:
- Report: .claude/reports/active/[agent]-[task]-2026-01-22.md
- Format: Use template in .claude/templates/agent-report-template.md

Critical:
1. Stay in your scope (pre-commit hook enforces)
2. Create report BEFORE returning
3. NEVER commit (only Master commits)
```

**Why explicit context?** Don't rely on agents reading documentation.

---

## Commit Message Format (Master only)

```bash
git commit -m "$(cat <<'EOF'
[type]: [concise description]

[Optional: What changed and why]
[Optional: Which agents worked on this]

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

**Types**: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`

**Example**:
```bash
git commit -m "$(cat <<'EOF'
feat: Implement SEO improvements across site

Designer: Added hreflang meta tags to all pages
CTO: Fixed sitemap.xml generation configuration
QA: Validated SEO compliance with Lighthouse

Executed in parallel (2h vs 4h sequential)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

---

## Migration from System 4.0

### What You Need to Do

**Total time**: 10 minutes

1. **Install pre-commit hook** (5 min)
   ```bash
   # Copy hook code from above
   chmod +x .git/hooks/pre-commit
   # Test with fake commit
   ```

2. **That's it!**
   - No workflow changes
   - Master decides parallel/sequential per task
   - Pre-commit hook enforces automatically

### What Changed

**Before (4.0)**:
- Sequential only
- Manual scope management
- No automated enforcement

**After (4.5)**:
- Sequential by default, parallel when obvious
- Clear scope ownership
- Pre-commit hook prevents violations

**What stayed the same**:
- Master orchestrates
- Agents create reports
- Only Master commits
- Sequential workflow still primary

---

## Performance Expectations

### Conservative Estimates

| Scenario | 4.0 Time | 4.5 Time | Savings |
|----------|----------|----------|---------|
| **1 agent task** | 2h | 2h | 0% (same) |
| **2 agents, sequential** | 4h | 4h | 0% (same) |
| **2 agents, parallel** | 4h | 2h | 50% |
| **3 agents, parallel** | 6h | 2h | 67% |

**Overall expected**: 30-40% faster (mix of parallel and sequential)

**Not expected**: 60-70% (that's full System 5.0, which is overkill)

---

## Troubleshooting

### Pre-Commit Hook Blocks My Commit

**Symptom**: `âŒ SCOPE VIOLATION: Designer cannot modify scripts/test.py`

**Cause**: You're modifying files outside your scope

**Fix**:
1. **Option A**: Unstage the file
   ```bash
   git reset HEAD scripts/test.py
   ```

2. **Option B**: Create report for Master
   ```markdown
   # .claude/reports/active/designer-cross-scope-2026-01-22.md

   I need to modify scripts/test.py but it's in CTO scope.
   Reason: [explain why]
   Suggested approach: [how to coordinate]
   ```

3. **Option C**: Ask Master to handle cross-scope work

### How Do I Know If Scopes Overlap?

**Quick check**:
```bash
# List files you'll modify
echo "layouts/index.html
assets/css/main.css"

# List files other agent will modify
echo "scripts/generate.py
data/queue.json"

# Any overlap? (same file in both lists)
# NO â†’ Parallel OK
# YES â†’ Sequential
```

### Parallel Execution Seems Slower

**Possible causes**:
1. **Git conflicts** â†’ Should have used sequential
2. **Dependency not caught** â†’ Designer waiting for CTO
3. **Master review overhead** â†’ Reviewing 3 reports takes time

**Fix**: Use sequential for complex tasks, parallel only for obvious cases

---

## Success Metrics (Track These)

### After 1 Week
- [ ] Parallel tasks attempted: ____ (target: 3-5)
- [ ] Scope violations caught by hook: ____ (expect: 0-2)
- [ ] Time savings observed: ____ % (target: 20-40%)
- [ ] Confusion incidents: ____ (target: 0)

### After 1 Month
- [ ] Consistent time savings: ____ % (target: 30%+)
- [ ] Parallel success rate: ____ % (target: 90%+)
- [ ] System satisfaction: Agents report ease of use
- [ ] Decision: Keep 4.5 or revisit 4.0/5.0

---

## When to NOT Use System 4.5

### Stick with 4.0 (Sequential Only) If:
- Learning the system (first week)
- Very complex task with unclear scope
- Multiple cross-scope dependencies
- Urgent hotfix (sequential is safer)

### Consider Full 5.0 (Event Log) If:
- Consistently see 50%+ parallel opportunities
- 10+ agents (not 3-4)
- 20+ tasks/day (not 3-5)
- Master becomes bottleneck in 4.5

**Reality**: 4.5 is probably enough for your scale

---

## Quick Reference Card

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SYSTEM 4.5 QUICK REFERENCE             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DEFAULT: Sequential                     â”‚
â”‚  WHEN OBVIOUS: Parallel                  â”‚
â”‚                                          â”‚
â”‚  SCOPE OWNERSHIP:                        â”‚
â”‚  â€¢ Designer â†’ layouts/, assets/css/      â”‚
â”‚  â€¢ CTO â†’ scripts/, .github/, hugo.toml   â”‚
â”‚  â€¢ QA â†’ tests/                           â”‚
â”‚  â€¢ Master â†’ .claude/                     â”‚
â”‚                                          â”‚
â”‚  DECISION TREE:                          â”‚
â”‚  1. Scopes overlap? â†’ Sequential         â”‚
â”‚  2. Has dependency? â†’ Sequential         â”‚
â”‚  3. Both NO? â†’ Parallel                  â”‚
â”‚  4. Unsure? â†’ Sequential (safe default)  â”‚
â”‚                                          â”‚
â”‚  SAFETY:                                 â”‚
â”‚  â€¢ Pre-commit hook enforces scopes       â”‚
â”‚  â€¢ All agents create reports             â”‚
â”‚  â€¢ Only Master commits                   â”‚
â”‚                                          â”‚
â”‚  GOLDEN RULE:                            â”‚
â”‚  When in doubt, use sequential.          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Version History

- **4.5** (2026-01-22): Added pragmatic parallelization, scope enforcement
- **4.0** (2026-01-22): Sequential workflows, consolidated docs
- **3.0** (2026-01-20): Separate agent files (archived)
- **2.0** (2026-01-18): Multi-agent patterns
- **1.0** (2026-01-15): Initial system

---

**This is the primary reference for System 4.5.**
**For full context: Read CLAUDE.md alongside this document.**

**System 4.5 = 90% of 4.0 simplicity + 30% performance gain**
