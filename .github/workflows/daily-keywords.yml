name: Daily Keyword Curation

on:
  schedule:
    # Run every day at 7:00 AM UTC (4:00 PM KST) - Earlier to avoid workflow conflicts
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of keywords to generate'
        required: false
        default: '25'
      keyword_type:
        description: 'Keyword type (trend, evergreen, or mixed)'
        required: false
        default: 'mixed'
      evergreen_ratio:
        description: 'Ratio of evergreen keywords in mixed mode (0.0-1.0)'
        required: false
        default: '0.2'

jobs:
  curate-keywords:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for other workflows (git lock)
        run: |
          MAX_WAIT=300  # 5 minutes max wait
          WAIT_TIME=0
          while [ -f .workflow-lock ]; do
            if [ $WAIT_TIME -ge $MAX_WAIT ]; then
              echo "âš ï¸ Lock timeout - proceeding anyway"
              break
            fi
            echo "â³ Waiting for other workflow to finish... ($WAIT_TIME/$MAX_WAIT seconds)"
            sleep 10
            WAIT_TIME=$((WAIT_TIME + 10))
            git pull origin main  # Refresh to check lock status
          done
          echo "ğŸ”’ Creating workflow lock"
          echo "$(date): Keyword curation workflow started" > .workflow-lock
          git add .workflow-lock
          git commit -m "ğŸ”’ Lock: Keyword workflow started" || true
          git push origin main || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic requests python-dotenv

      - name: Clear all pending keywords (fresh start daily)
        run: |
          echo "ğŸ—‘ï¸ Clearing all pending keywords for fresh daily batch..."
          python3 << 'EOF'
          import json
          with open('data/topics_queue.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          pending_count = len([t for t in data['topics'] if t['status'] == 'pending'])
          data['topics'] = [t for t in data['topics'] if t['status'] != 'pending']
          with open('data/topics_queue.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          print(f"âœ… Cleared {pending_count} pending keywords")
          print(f"   Remaining: {len(data['topics'])} completed topics")
          EOF

      - name: Curate new keywords
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}

        run: |
          # Explicitly mask secrets in GitHub Actions logs
          echo "::add-mask::${{ secrets.ANTHROPIC_API_KEY }}"
          echo "::add-mask::${{ secrets.BRAVE_API_KEY }}"

          COUNT="${{ github.event.inputs.count || '25' }}"
          TYPE="${{ github.event.inputs.keyword_type || 'mixed' }}"
          RATIO="${{ github.event.inputs.evergreen_ratio || '0.2' }}"

          echo "ğŸ“ Generating $COUNT new keywords (type: $TYPE, evergreen ratio: $RATIO)..."
          python scripts/keyword_curator.py --count "$COUNT" --type "$TYPE" --evergreen-ratio "$RATIO" --auto

      - name: Commit and push keywords
        run: |
          git config user.name "Keyword Bot"
          git config user.email "bot@jakes-tech-insights.com"

          if ! git diff --quiet data/topics_queue.json; then
            git add data/topics_queue.json
            git commit -m "ğŸ”‘ Auto-curated keywords: Daily trending topics update"
            git push origin main
            echo "âœ… Successfully added new keywords to queue"
          else
            echo "âš ï¸ No new keywords to commit"
          fi

      - name: Release workflow lock
        if: always()
        run: |
          if [ -f .workflow-lock ]; then
            git pull origin main || true
            git rm -f .workflow-lock || rm -f .workflow-lock
            git add .workflow-lock 2>/dev/null || true
            git commit -m "ğŸ”“ Unlock: Keyword workflow completed" || true
            git push origin main || true
            echo "ğŸ”“ Workflow lock released"
          fi

      - name: Summary
        run: |
          TYPE="${{ github.event.inputs.keyword_type || 'mixed' }}"
          echo "âœ… Keyword curation complete"
          echo "ğŸ“Š Queue updated with $TYPE keywords"
          echo "ğŸ”„ Next: Content generation workflow will consume these keywords"
